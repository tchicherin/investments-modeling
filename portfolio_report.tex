
\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{amsmath, amssymb}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{geometry}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,shapes.multipart}

\geometry{margin=1in}
\hypersetup{colorlinks=true,linkcolor=blue,urlcolor=blue}

\lstdefinestyle{cppstyle}{%
  language=C++,
  basicstyle=\ttfamily\small,
  keywordstyle=\color{blue}\bfseries,
  commentstyle=\itshape\color{gray!70!black},
  stringstyle=\color{teal!70!black},
  showstringspaces=false,
  columns=fullflexible,
  tabsize=2,
  frame=single,
  breaklines=true
}

\begin{document}

\begin{center}
{\LARGE \textbf{Отчёт по практикуму «Система управления инвестиционным портфелем»}}\\[6pt]
{\large Qt/CMake, C++17}\\[2pt]
\end{center}

\section{Уточнённая формулировка задания}
Требуется разработать настольное приложение, моделирующее работу управляющего инвестиционным фондом. Симуляция ведётся помесячно в течение $M$ шагов. На каждом шаге обновляется \emph{рынок} (акции, валюты, облигации, металлы), пересчитывается \emph{портфель} (прибыль/убыток по позициям), удерживается налог с положительной прибыли и моделируются притоки/оттоки капитала. Пользователь может в любой момент покупать/продавать инструменты. По завершении выводятся сводные KPI и помесячная история; доступен экспорт в CSV.

\section{Диаграмма классов}
\begin{figure}[h!]
\centering
\resizebox{0.95\linewidth}{!}{\begin{tikzpicture}[transform shape,
  node distance=12mm and 14mm,
  class/.style={rectangle, draw, rounded corners, align=center, font=\small, minimum width=3.2cm, minimum height=9mm, fill=gray!3},
  abstract/.style={class, dashed, fill=gray!1},
  uses/.style={dashed,-{Stealth}},
  has/.style={-{Stealth}},
  inherit/.style={-{Triangle[length=3mm,width=3mm]}},
  agg/.style={-{Diamond[open]}-{Stealth}}
]

\node[class] (mw) {MainWindow\\\footnotesize GUI};
\node[class, right=of mw] (sd) {SummaryDialog\\\footnotesize GUI};

\node[class, below=of mw] (gc) {GameController};
\node[class, below left=of gc] (mkt) {Market};
\node[class, below right=of gc] (fund) {InvestmentFund};
\node[class, below=of fund] (port) {Portfolio};

\node[abstract, below=of port] (inv) {Investment\\\footnotesize (abstract)};
\node[class, below left=8mm and 2.8cm of inv] (dep) {DepositInvestment};
\node[class, below=8mm of inv] (bond) {BondInvestment};
\node[class, below right=8mm and 2.8cm of inv] (cur) {CurrencyInvestment};
\node[class, right=18mm of cur] (stock) {StockInvestment};
\node[class, left=18mm of dep] (metal) {MetalInvestment};

\draw[uses] (mw) -- (gc);
\draw[uses] (sd) |- (gc);

\draw[has] (gc) -- (mkt);
\draw[has] (gc) -- (fund);
\draw[has] (fund) -- (port);

\draw[agg] (port) -- node[midway, right, font=\scriptsize]{*} (inv);

\draw[inherit] (dep) -- (inv);
\draw[inherit] (bond) -- (inv);
\draw[inherit] (cur) -- (inv);
\draw[inherit] (stock) -- (inv);
\draw[inherit] (metal) -- (inv);

\end{tikzpicture}}
\caption{Компоненты приложения и их связи.}
\label{fig:class-diagram}
\end{figure}

\section{Спецификация основных классов (интерфейсы C++)}
Ниже приведены ключевые фрагменты интерфейсов с принудительными разрывами страниц после указанных блоков, чтобы избежать «разрыва» кода на границе страницы.

\subsection*{GameController}
\begin{lstlisting}[style=cppstyle]
class GameController : public QObject {
public:
  GameController(double initialCapital, int totalMonths,
                 double taxRate, unsigned seed, QObject* parent=nullptr);
  void nextMonth();                // один шаг симуляции: рынок -> фонд -> история
  SummaryStats computeSummary() const; // KPI
  Market& market();                // доступ к Market для GUI
  InvestmentFund& fund();          // доступ к InvestmentFund для GUI
  int totalMonths() const;         // горизонт моделирования
  int currentMonth() const;        // текущий месяц (0..M-1)
signals:
  void updated();                  // сигнал на обновление GUI
};
\end{lstlisting}

\subsection*{Market}
\begin{lstlisting}[style=cppstyle]
struct Company  { QString name; double price; };
struct Currency { QString name; double rate; };
struct Bond     { QString name; double annualYield; };
struct Metal    { QString name; double price; };
struct MarketState { double depositRate; };

class Market {
public:
  void randomizeMonth(); // сдвиг цен/ставок за месяц (акции, FX, бонды, металлы)

  // чтение справочников
  const std::vector<Company>&  companies()  const;
  const std::vector<Currency>& currencies() const;
  const std::vector<Bond>&     bonds()      const;
  const std::vector<Metal>&    metals()     const;
  const MarketState&           current()    const;

  // управление справочниками (add/remove/set ...)
  void addCompany(const QString& name, double price);
  void removeCompanyAt(int index);
  void setCompanyPrice(int index, double price);
  // ... (аналогично для валют/облигаций/металлов)

  // базовые ставки
  void setDepositRate(double r);
};
\end{lstlisting}
\pagebreak

\subsection*{Investment (абстрактный) и часть наследников}
\begin{lstlisting}[style=cppstyle]
class Market;

class Investment {
public:
  explicit Investment(const QString& name);
  virtual ~Investment() = default;

  virtual QString type() const = 0;                // "Deposit"/"Stock"/...
  const QString& name() const;                     // отображаемое имя
  virtual double marketValue(const Market&) const = 0; // оценка позиции
  virtual double stepMonth(const Market&) = 0;     // прибыль за месяц
};

class DepositInvestment : public Investment {
public:
  DepositInvestment(const QString& name, double amount,
                    double annualRate, int months);
  double marketValue(const Market&) const override;
  double stepMonth(const Market& mkt) override; // % и пролонгация по depositRate
};
\end{lstlisting}
\pagebreak

\subsection*{Остальные наследники Investment}
\begin{lstlisting}[style=cppstyle]
class BondInvestment : public Investment {
public:
  BondInvestment(const QString& name, double amount, double annualYield);
  double marketValue(const Market&) const override;
  double stepMonth(const Market&) override; // купон = principal*(yield/12)
};

class CurrencyInvestment : public Investment {
public:
  CurrencyInvestment(const QString& name, double amount, double monthlyRate);
  double marketValue(const Market&) const override;
  double stepMonth(const Market&) override; // amount *= (1 + monthlyRate)
};

class MetalInvestment : public Investment {
public:
  MetalInvestment(const QString& name, double amount, double initialPrice);
  double marketValue(const Market&) const override;
  double stepMonth(const Market&) override; // mark-to-market по m.metals()
};
[style=cppstyle]
class StockInvestment : public Investment {
public:
  StockInvestment(const QString& name, const QString& assetName,
                  double amount, const Market& m);
  double marketValue(const Market& m) const override;
  double stepMonth(const Market& m) override; // mark-to-market по m.companies()
};
\end{lstlisting}

\subsection*{Portfolio и MonthResult}
\begin{lstlisting}[style=cppstyle]
class Portfolio {
public:
  void add(const std::shared_ptr<Investment>& inv);
  void removeAt(int index);
  double totalValue(const Market& m) const; // суммарная оценка
  double stepAll(const Market& m) const;    // суммарная прибыль за месяц
  const std::vector<std::shared_ptr<Investment>>& items() const;
  int size() const;
};
struct MonthResult {
  int monthIndex;
  double equityBefore, portfolioProfit, taxPaid, flow, equityAfter;
  };
\end{lstlisting}
\pagebreak

\subsection*{InvestmentFund}
\begin{lstlisting}[style=cppstyle]
class InvestmentFund {
public:
  explicit InvestmentFund(double initialCapital);
  double equity(const Market& m) const;
  double cash() const;              void setCash(double v);
  Portfolio& portfolio();           const Portfolio& portfolio() const;

  // Месячный шаг
  double      simulateMonth(Market& market, double taxRate);
  MonthResult simulateMonthDetailed(Market& market, double taxRate, int month);

  // Операции покупки/продажи
  bool buyDeposit(const QString& name, double amount, double annualRate, int months);
  bool buyStock  (const QString& name, double amount, const Market& m);
  bool buyCurrency(const QString& name, double amount, double monthlyRate);
  bool buyBond   (const QString& name, double amount, double annualYield);
  bool buyMetal  (const QString& name, double amount, const Market& m);
  void sellInvestment(int index, const Market& m);
};
\end{lstlisting}

\section{Диаграмма объектов}
\begin{figure}[h!]
\centering
\resizebox{0.95\linewidth}{!}{\begin{tikzpicture}[transform shape,
  node distance=10mm and 16mm,
  obj/.style={rectangle, draw, rounded corners=2pt, align=center, font=\small, fill=blue!3, minimum width=3.6cm}
]
\node[obj] (mw) {mw: MainWindow};
\node[obj, right=of mw] (sd) {sd: SummaryDialog\\\footnotesize (по завершении)};

\node[obj, below=of mw] (gc) {gc: GameController};
\node[obj, below left=of gc] (mkt) {mkt: Market\\\footnotesize \{companies, currencies, bonds, metals, depositRate\}};
\node[obj, below right=of gc] (fund) {fund: InvestmentFund\\\footnotesize cash, totalProfit};
\node[obj, below=of fund] (port) {port: Portfolio\\\footnotesize items: vector<Investment>};

\node[obj, below left=of port] (d) {DepositInvestment("Bank", ...)};
\node[obj, below=of port]      (s) {StockInvestment("ACME", ...)};
\node[obj, below right=of port](m) {MetalInvestment("Gold", ...)};

\draw[-{Stealth}] (mw) -- (gc);
\draw[-{Stealth}] (sd) -- (gc);
\draw[-{Stealth}] (gc) -- (mkt);
\draw[-{Stealth}] (gc) -- (fund);
\draw[-{Stealth}] (fund) -- (port);
\draw[-{Stealth}] (port) -- (d);
\draw[-{Stealth}] (port) -- (s);
\draw[-{Stealth}] (port) -- (m);
\end{tikzpicture}}
\caption{Основные объекты во время работы программы и их связи.}
\label{fig:object-diagram}
\end{figure}

\section{Инструментальные средства}
C++ стандартная библиотека (\texttt{<algorithm>}, \texttt{<numeric>}, \texttt{<cmath>}, \texttt{<random>} и др.) и Qt 6 (Widgets): \texttt{QApplication}, \texttt{QMainWindow}, \texttt{QDialog}, \texttt{QLabel}, \texttt{QPushButton}, \texttt{QTabWidget}, \texttt{QTableWidget}, \texttt{QTableWidgetItem}, \texttt{QVBoxLayout}, \texttt{QHBoxLayout}, \texttt{QFormLayout}, \texttt{QSpinBox}, \texttt{QDoubleSpinBox}, \texttt{QLineEdit}, \texttt{QFileDialog}, \texttt{QMessageBox}, \texttt{QHeaderView}, \texttt{QTextStream}, \texttt{QString}/\texttt{QStringList} и др.

\section{Модульная (файловая) структура}
\begin{center}
\begin{tabular}{ll}
\toprule
Файл & Классы/содержимое \\
\midrule
\texttt{main.cpp} & точка входа; создание \texttt{GameController}, \texttt{MainWindow} \\
\texttt{GameController.cpp} & \texttt{GameController} (конструктор, \texttt{nextMonth()}, \texttt{computeSummary()}) \\
\texttt{Market.cpp} & \texttt{Market} (сто\-хастика, CRUD справочников) \\
\texttt{Investment.h/.cpp} & абстрактный \texttt{Investment} \\
\texttt{DepositInvestment.cpp} & \texttt{DepositInvestment} \\
\texttt{BondInvestment.cpp} & \texttt{BondInvestment} \\
\texttt{CurrencyInvestment.cpp} & \texttt{CurrencyInvestment} \\
\texttt{MetalInvestment.cpp} & \texttt{MetalInvestment} \\
\texttt{StockInvestment.cpp} & \texttt{StockInvestment} \\
\texttt{Portfolio.cpp} & \texttt{Portfolio} (контейнер позиций) \\
\texttt{InvestmentFund.cpp} & \texttt{InvestmentFund} (учёт месяца, buy/sell) \\
\texttt{MainWindow.cpp} & GUI: вкладки, таблицы, диалоги, `Apply Settings` \\
\texttt{SummaryDialog.cpp} & окно KPI и экспорт CSV \\
\texttt{Utils.cpp} & \texttt{Rng} (генератор случайностей) \\
\bottomrule
\end{tabular}
\end{center}

\section{Краткое описание пользовательского интерфейса}
\textbf{Simulation.} Верхняя панель: месяц/из $M$, налог, ставка депозита, \emph{Total Equity}, \emph{Cash}, \emph{Last Month Profit}. Таблица портфеля и вкладки котировок (акции с $\Delta$, облигации, металлы). Кнопки: \emph{Next Month}, \emph{Add Deposit/Stock/Currency/Bond/Metal}, \emph{Sell Selected}.

\textbf{Settings.} Параметры: \emph{Total months}, \emph{Initial capital}, \emph{Tax rate}, \emph{Deposit rate}; справа — справочники \emph{Companies}, \emph{Currencies}, \emph{Bonds}, \emph{Metals}. Кнопка \emph{Apply Settings}.

\textbf{Диалоги.} Покупка депозита (сумма+ставка+срок), акции (сумма+компания), валюты (сумма+месячная ставка), облигации (сумма+выпуск), металла (сумма+тип). Валидация на кэш/параметры.

\textbf{Итоги.} \emph{Simulation Summary}: KPI и таблица помесячной истории, \emph{Export CSV}.

\end{document}
