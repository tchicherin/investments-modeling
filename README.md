# PortfolioSim — учебный практикум по управлению инвестиционным портфелем (Qt/C++)

## TL;DR / Суть практикума
Это настольное приложение симулирует работу управляющего фондом: вы задаёте рынок (акции/валюты/облигации/металлы), покупаете инструменты в портфель, а затем «прокручиваете» помесячную динамику. На каждом шаге рынок случайно меняется, позиции переоцениваются, начисляются проценты, удерживается налог и моделируются притоки/оттоки. В конце показываются KPI (итоговая/годовая доходность, волатильность, доля прибыльных месяцев, max drawdown, налоги и притоки) и помесячная история, которую можно экспортировать в CSV.  

## Ключевые возможности
- Помесячная симуляция рынка и портфеля (GUI на Qt Widgets).
- Инструменты: депозит (с пролонгацией), облигации, валюта, металлы, акции.
- Быстрые диалоги покупки/продажи, редактируемые справочники активов.
- Итоговая сводка с KPI + экспорт истории в CSV.

## Архитектура (по модулям)
- **GameController** — главный цикл, хранит историю, считает агрегированные метрики (KPI); метод `nextMonth()` дергает рынок и фонд.  
- **Market** — «мировые» данные и стохастика рынка за месяц: акции с нормальным шумом (~0.5% дрейф, ~5% σ), валюты ±2%, облигации ±0.5 п.п. к доходности, металлы ±3%.  
- **InvestmentFund / Portfolio** — кэш + набор позиций, покупка/продажа, помесячная симуляция (налог, потоки).  
- **Investments** — базовый `Investment` и конкретные реализации:  
  - `DepositInvestment` — ежемесячные проценты, пролонгация с рыночной `depositRate` в конце срока;  
  - `BondInvestment` — купон: `annualYield/12` от номинала с капитализацией;  
  - `CurrencyInvestment` — помесячная ставка на сумму;  
  - `StockInvestment`, `MetalInvestment` — оценка по рыночной цене (mark-to-market).  
- **MainWindow** — интерфейс: вкладка **Simulation** (кнопки, портфель, котировки) и **Settings** (параметры и справочники), кнопка **Apply Settings**.  
- **SummaryDialog** — окно KPI и таблица помесячной истории с кнопкой **Export CSV**.  

> Подробные указания на исходники см. в разделе «Ссылки на код».

## Математика/логика симуляции
### Цикл месяца
1. Обновить рынок: `Market::randomizeMonth()` — пересчитать цены/ставки согласно стохастике.  
2. Для каждой позиции вызвать `stepMonth(market)` и суммировать портфельную прибыль/убыток.  
3. **Налог:** если прибыль за месяц положительная — удержать `tax = taxRate * profit`.  
4. **Притоки/оттоки:** упрощённая модель `flow = 0.5 * profit` (добавляется в кэш).  
5. Обновить `cash`, `equity = cash + marketValue(portfolio)`, записать `MonthResult` в историю.

### KPI (из истории)
- Итоговая доходность: `TotalReturn = (E_T - E_0)/E_0`.  
- Месячные доходности: `r_t = (E_t - E_{t-1})/E_{t-1}` → средняя и σ.  
- Годовая оценка (аппрокс.): `(1 + TotalReturn)^(12/T) - 1`.  
- % прибыльных месяцев, max drawdown, суммарные налоги и притоки.  

## Руководство пользователя (GUI)
1. **Запуск**  
   Соберите проект (см. «Сборка и запуск»). При старте по умолчанию: капитал `560000`, горизонт `24` месяцев, налог `0.17`.  

2. **Настройка рынка (Settings)**  
   Добавьте компании/валюты/облигации/металлы (**Add …**), при необходимости отредактируйте значения в таблицах и нажмите **Apply Settings**.  

3. **Покупка активов (Simulation)**  
   Кнопки: **➕ Add Deposit/Stock/Currency/Bond/Metal** открывают быстрые диалоги; продажи — **✖ Sell Selected** (продаёт по текущей рыночной цене). Если список инструментов пуст, появится предупреждение «Add … in Settings first».  

4. **Шаг времени**  
   Жмите **▶ Next Month** для перехода к следующему месяцу. Рынок перетряхнётся, портфель пересчитается, на плашках обновятся капитал/кэш/прибыль.  

5. **Итоги**  
   После достижения заданного числа месяцев откроется **Simulation Summary** с KPI и таблицей истории; можно **Export CSV** (`simulation_history.csv`).  

## Сборка и запуск
### Требования
- CMake ≥ 3.21  
- Компилятор C++17  
- Qt 6.5+ (модуль Widgets)

### Команды
```bash
cmake -S . -B build -DCMAKE_PREFIX_PATH="/Путь/к/Qt/6.5.x/<toolchain>"
cmake --build build --config Release -j
./build/PortfolioSim   # Linux/macOS
# или .\build\Release\PortfolioSim.exe на Windows
```

## Структура проекта (по CMake)
```
app/
  main.cpp
  MainWindow.{h,cpp}
  GameController.{h,cpp}
  Market.{h,cpp}
  Portfolio.{h,cpp}
  Investment.{h,cpp}
  DepositInvestment.{h,cpp}
  BondInvestment.{h,cpp}
  CurrencyInvestment.{h,cpp}
  MetalInvestment.{h,cpp}
  StockInvestment.{h,cpp}
  InvestmentFund.{h,cpp}
  SummaryDialog.{h,cpp}
  Utils.{h,cpp}
CMakeLists.txt
```

## Воспроизводимость/настройки модели
- Для детерминированных прогонов зафиксируйте seed генератора в `Utils.cpp`/`Rng`.  
- Параметры «шума» рынка можно хардкодить в `Market::randomizeMonth()` или пробрасывать из GUI (в коде уже есть спинбоксы/сеттеры).  

## Экспорт и формат CSV
`Month,EquityBefore,PortfolioProfit,TaxPaid,Flow,EquityAfter` — заголовок и поля помесячной истории. Подходит для Excel/ноутбуков с графиками.

## FAQ / Troubleshooting
**Нет нужного инструмента в диалоге покупки.** Сначала добавьте его во **вкладке Settings**, затем повторите покупку.  
**Недостаточно средств для покупки.** Покупки возвращают `false`, GUI покажет предупреждение, кэш не уходит в минус.  
**Хочу с нуля поменять сроки/налог/ставки.** Поменяйте в **Settings** и нажмите **Apply Settings** — счётчик месяцев сбросится.  

## Ссылки на код (источники фактов)
- Главный цикл `nextMonth()`, расчёт KPI: `GameController.cpp`.  
- Стохастика рынка и CRUD справочников: `Market.cpp`.  
- Депозит (месячные проценты + пролонгация): `DepositInvestment.cpp`.  
- Облигация (годовая доходность /12): `BondInvestment.cpp`.  
- Валюта (месячная ставка на сумму): `CurrencyInvestment.cpp`.  
- Покупка/продажа и портфельная симуляция, налог и притоки: `InvestmentFund.cpp`.  
- GUI (кнопки, таблицы, Apply Settings): `MainWindow.cpp`.  
- Окно итогов и экспорт CSV: `SummaryDialog.cpp`.  
- Параметры по умолчанию (560000; 24; 0.17): `app/main.cpp`.  
- CMake с Qt Widgets: `CMakeLists.txt`.

## Лицензия
не знаю что это и зачем, так что отсутствует 
